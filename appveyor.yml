version: 1.0.{build}
clone_depth: 10
shallow_clone: true
image: Visual Studio 2015
platform: Win32
configuration: Debug
install:
  # SDL
  - ps: Start-FileDownload 'https://www.libsdl.org/release/SDL-devel-1.2.15-VC.zip'
  - 7z x SDL-devel-1.2.15-VC.zip
  - set PATH=%APPVEYOR_BUILD_FOLDER%\SDL-1.2.15\include\;%APPVEYOR_BUILD_FOLDER%\SDL-1.2.15\lib\x86\;%PATH%
  # SDL_image
  - ps: Start-FileDownload 'https://www.libsdl.org/projects/SDL_image/release/SDL_image-devel-1.2.12-VC.zip'
  - 7z x SDL_image-devel-1.2.12-VC.zip
  - set PATH=%APPVEYOR_BUILD_FOLDER%\SDL_image-1.2.12\include\;%APPVEYOR_BUILD_FOLDER%\SDL_image-1.2.12\lib\x86\;%PATH%
  # SDL_ttf
  - ps: Start-FileDownload 'https://www.libsdl.org/projects/SDL_ttf/release/SDL_ttf-devel-2.0.11-VC.zip'
  - 7z x SDL_ttf-devel-2.0.11-VC.zip
  - set PATH=%APPVEYOR_BUILD_FOLDER%\SDL_ttf-2.0.11\include\;%APPVEYOR_BUILD_FOLDER%\SDL_ttf-2.0.11\lib\x86\;%PATH%
  # SDL_mixer
  - ps: Start-FileDownload 'https://www.libsdl.org/projects/SDL_mixer/release/SDL_mixer-devel-1.2.12-VC.zip'
  - 7z x SDL_mixer-devel-1.2.12-VC.zip
  - set PATH=%APPVEYOR_BUILD_FOLDER%\SDL_mixer-1.2.12\include\;%APPVEYOR_BUILD_FOLDER%\SDL_mixer-1.2.12\lib\x86\;%PATH%
  # setup VS2015
  - call "C:\Program Files (x86)\Microsoft Visual Studio 14.0\VC\vcvarsall.bat" x86
  # SDL_gfx, need to compile from source
  - ps: Start-FileDownload 'http://www.ferzkopp.net/Software/SDL_gfx-2.0/SDL_gfx-2.0.26.tar.gz'
  - 7z x SDL_gfx-2.0.26.tar.gz && 7z x SDL_gfx-2.0.26.tar && cd SDL_gfx-2.0.26
  - echo project(SDL_gfx) > CMakeLists.txt
  - echo Find_Package(SDL REQUIRED) >> CMakeLists.txt
  - echo add_definitions(-DDLL_EXPORT) >> CMakeLists.txt
  - echo include_directories(${SDL_INCLUDE_DIR}) >> CMakeLists.txt
  - echo add_library(SDL_gfx SHARED SDL_framerate.c SDL_gfxBlitFunc.c SDL_gfxPrimitives.c SDL_imageFilter.c SDL_rotozoom.c) >> CMakeLists.txt
  - echo Target_Link_Libraries(SDL_gfx ${SDL_LIBRARY}) >> CMakeLists.txt
  - mkdir build && cd build
  - cmake -G "Visual Studio 14 2015" ..
  - msbuild SDL_gfx.sln /target:SDL_gfx /p:Configuration=%CONFIGURATION%
  - cd ..\..
  - set PATH=%APPVEYOR_BUILD_FOLDER%\SDL_gfx-2.0.26\;%APPVEYOR_BUILD_FOLDER%\SDL_gfx-2.0.26\build\%CONFIGURATION%\;%PATH%
  # libcurl...
  - ps: Start-FileDownload 'https://bintray.com/artifact/download/vszakats/generic/curl-7.59.0-win32-mingw.zip'
  - 7z x curl-7.59.0-win32-mingw.zip
  # ???
  - cd curl-7.59.0-win32-mingw\lib && rename libcurl.dll.a libcurl.lib && cd ..\..
  - set PATH=%APPVEYOR_BUILD_FOLDER%\curl-7.59.0-win32-mingw\include\;%APPVEYOR_BUILD_FOLDER%\curl-7.59.0-win32-mingw\lib\;%PATH%
  # zlib...
  - ps: Start-FileDownload 'http://www.zlib.net/zlib1211.zip'
  - 7z x zlib1211.zip && cd zlib-1.2.11
  - mkdir build && cd build
  - cmake -G "Visual Studio 14 2015" ..
  - msbuild zlib.sln /target:zlib /p:Configuration=%CONFIGURATION%
  # ???
  - copy zconf.h ..\zconf.h
  - cd ..\..
  - set PATH=%APPVEYOR_BUILD_FOLDER%\zlib-1.2.11\;%APPVEYOR_BUILD_FOLDER%\zlib-1.2.11\build\%CONFIGURATION%\;%PATH%
  # libarchive, need to compile from source (very slow)
  - cd ..
  - git clone --depth 3 https://github.com/libarchive/libarchive.git
  - cd libarchive
  - mkdir builddd && cd builddd
  - cmake -G "Visual Studio 14 2015" ..
  - msbuild libarchive.sln /target:archive /p:Configuration=%CONFIGURATION%
  - cd /d %APPVEYOR_BUILD_FOLDER%
  - set PATH=%APPVEYOR_BUILD_FOLDER%\..\libarchive\libarchive\;%APPVEYOR_BUILD_FOLDER%\..\libarchive\builddd\libarchive\%CONFIGURATION%\;%PATH%
  # %APPVEYOR_BUILD_FOLDER%\..\libarchive\builddd\bin\%CONFIGURATION%\;
  # lua5.2, need to compile from source
  - ps: Start-FileDownload 'http://www.lua.org/ftp/lua-5.2.4.tar.gz'
  - 7z x lua-5.2.4.tar.gz && 7z x lua-5.2.4.tar && cd lua-5.2.4\src
  - echo project(lua52) > CMakeLists.txt
  - echo add_definitions(-DLUA_BUILD_AS_DLL) >> CMakeLists.txt
  - echo add_library(lua52 SHARED lapi.c lcode.c lctype.c ldebug.c ldo.c ldump.c lfunc.c lgc.c llex.c lmem.c lobject.c lopcodes.c lparser.c lstate.c lstring.c ltable.c ltm.c lundump.c lvm.c lzio.c lauxlib.c lbaselib.c lbitlib.c lcorolib.c ldblib.c liolib.c lmathlib.c loslib.c lstrlib.c ltablib.c loadlib.c linit.c) >> CMakeLists.txt
  - mkdir build && cd build
  - cmake -G "Visual Studio 14 2015" ..
  - msbuild lua52.sln /target:lua52 /p:Configuration=%CONFIGURATION%
  # ???
  - copy %CONFIGURATION%\lua52.lib %CONFIGURATION%\lua.lib
  - cd ..\..\..
  - set PATH=%APPVEYOR_BUILD_FOLDER%\lua-5.2.4\src\;%APPVEYOR_BUILD_FOLDER%\lua-5.2.4\src\build\%CONFIGURATION%\;%PATH%
before_build:
  - mkdir build && cd build
  - cmake -G "Visual Studio 14 2015" ..
build:
  project: build\meandmyshadow.sln
  verbosity: normal
